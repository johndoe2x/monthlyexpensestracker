<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expense Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        // Drag and Drop functionality
        let draggedElement = null;
        
        // Sorting functionality
        function sortExpenses() {
            const sortValue = document.getElementById('sortSelect').value;
            currentSort = sortValue;
            
            console.log('Sorting by:', sortValue); // Debug log
            
            if (sortValue === 'none') {
                expenses = [...originalOrder];
            } else if (sortValue === 'amount-high') {
                expenses = [...expenses].sort((a, b) => b.amount - a.amount);
            } else if (sortValue === 'amount-low') {
                expenses = [...expenses].sort((a, b) => a.amount - b.amount);
            }
            
            console.log('Expenses after sort:', expenses.slice(0, 3)); // Debug log
            renderExpenses();
            updateSummary();
        }
        
        // Budget Management
        function showBudgetManager() {
            const manager = document.getElementById('budgetManager');
            const inputsContainer = document.getElementById('budgetInputs');
            
            // Get unique categories
            const categories = [...new Set(expenses.map(expense => expense.category))];
            
            inputsContainer.innerHTML = '';
            
            categories.forEach(category => {
                const currentBudget = budgets[category] || 0;
                const safeCategoryId = category.replace(/[^a-zA-Z0-9]/g, '');
                const inputDiv = document.createElement('div');
                inputDiv.className = 'budget-input-grid';
                inputDiv.innerHTML = `
                    <label>${category}</label>
                    <input type="number" id="budget-${safeCategoryId}" value="${currentBudget}" placeholder="‚Çπ Budget limit" class="form-input">
                    <button onclick="setBudget('${category.replace(/'/g, "\\\'")}')" class="btn-small btn-blue">Set</button>
                `;
                inputsContainer.appendChild(inputDiv);
            });
            
            manager.style.display = 'block';
        }
        
        function hideBudgetManager() {
            document.getElementById('budgetManager').style.display = 'none';
        }
        
        function setBudget(category) {
            const input = document.getElementById(`budget-${category.replace(/[^a-zA-Z0-9]/g, '')}`);
            const amount = parseFloat(input.value);
            
            if (amount >= 0) {
                budgets[category] = amount;
                localStorage.setItem('categoryBudgets', JSON.stringify(budgets));
                updateBudgetOverview();
                checkBudgetAlerts();
            }
        }

        function saveBudgets() {
            localStorage.setItem('categoryBudgets', JSON.stringify(budgets));
            hideBudgetManager();
            updateBudgetOverview();
            checkBudgetAlerts();
            document.getElementById('dataStatus').textContent = 'Budgets Saved ‚úì';
            setTimeout(() => {
                document.getElementById('dataStatus').textContent = 'Saved Locally';
            }, 2000);
        }
        
        function resetBudgets() {
            if (confirm('Are you sure you want to reset all budgets?')) {
                budgets = {};
                localStorage.removeItem('categoryBudgets');
                updateBudgetOverview();
            }
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .summary-icon {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 50%;
            margin-right: 1rem;
            font-size: 1.5rem;
        }
        
        .summary-icon.green { background: #f0fdf4; }
        .summary-icon.blue { background: #eff6ff; }
        .summary-icon.purple { background: #faf5ff; }
        
        .summary-text h3 {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .summary-text p {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .summary-text p.green { color: #059669; }
        .summary-text p.blue { color: #2563eb; }
        .summary-text p.purple { color: #7c3aed; }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .form-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-input {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .expenses-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .expenses-header {
            background: #f9fafb;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .expenses-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .expenses-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .expenses-table thead {
            background: #f3f4f6;
        }
        
        .expenses-table th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .expenses-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        .expenses-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .expense-row {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .expense-row:hover {
            background: #f9fafb;
        }
        
        .expense-row.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            background: #e0f2fe;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .expense-row.drag-over {
            border-top: 3px solid #3b82f6;
        }
        
        .drag-handle {
            color: #9ca3af;
            font-size: 1rem;
            margin-right: 0.5rem;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .amount-text {
            font-weight: 700;
            color: #059669;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            margin-right: 0.75rem;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #eff6ff;
        }
        
        .action-btn.delete {
            color: #dc2626;
        }
        
        .action-btn.delete:hover {
            background: #fef2f2;
        }
        
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .controls-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .budget-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .budget-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .budget-category {
            font-weight: 600;
            color: #374151;
        }
        
        .budget-amounts {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-fill.safe {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .budget-status {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .budget-status.safe { color: #10b981; }
        .budget-status.warning { color: #f59e0b; }
        .budget-status.danger { color: #ef4444; }
        
        .alert-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        .alert-popup.warning {
            background: #fffbeb;
            border-color: #fed7aa;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-title {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 0.25rem;
        }
        
        .alert-popup.warning .alert-title {
            color: #92400e;
        }
        
        .alert-message {
            font-size: 0.875rem;
            color: #7f1d1d;
        }
        
        .alert-popup.warning .alert-message {
            color: #78350f;
        }
        
        .budget-input-section {
            background: #f0f9ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .budget-input-grid {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-blue {
            background: #3b82f6;
            color: white;
        }
        
        .btn-blue:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            text-decoration: none;
            display: block;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-green:hover {
            background: #047857;
        }
        
        .btn-orange {
            background: #ea580c;
            color: white;
        }
        
        .btn-orange:hover {
            background: #c2410c;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.5rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .expenses-table th,
            .expenses-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="gradient-bg">
        <h1 class="header-title">üí∞ Monthly Expense Tracker</h1>
        <p class="header-subtitle">Family Budget Planner</p>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-icon green">üí∞</div>
                <div class="summary-text">
                    <h3>Total Budget</h3>
                    <p class="green" id="totalBudget">‚Çπ0</p>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon blue">üìä</div>
                <div class="summary-text">
                    <h3>Total Items</h3>
                    <p class="blue" id="totalItems">0</p>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon purple">üì±</div>
                <div class="summary-text">
                    <h3>Data Status</h3>
                    <p class="purple" id="dataStatus">Saved Locally</p>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <h2 class="form-title">üîß Controls</h2>
            <div class="controls-grid">
                <div>
                    <label class="form-title" style="font-size: 0.875rem; margin-bottom: 0.5rem; display: block;">Sort by Amount</label>
                    <select id="sortSelect" onchange="sortExpenses()" class="form-input">
                        <option value="none">Default Order</option>
                        <option value="amount-high">Amount: High to Low</option>
                        <option value="amount-low">Amount: Low to High</option>
                    </select>
                </div>
                <button onclick="showBudgetManager()" class="btn-primary">üí∞ Manage Budgets</button>
                <button onclick="resetBudgets()" class="btn-secondary btn-orange">üîÑ Reset Budgets</button>
            </div>
        </div>

        <!-- Budget Overview -->
        <div class="budget-section" id="budgetOverview">
            <h2 class="form-title">üìä Budget Overview</h2>
            <div id="budgetList">
                <!-- Budget items will be populated here -->
            </div>
        </div>

        <!-- Budget Manager Modal -->
        <div class="budget-input-section" id="budgetManager" style="display: none;">
            <h3 class="form-title">Set Category Budgets</h3>
            <div id="budgetInputs">
                <!-- Budget inputs will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button onclick="saveBudgets()" class="btn-primary">üíæ Save Budgets</button>
                <button onclick="hideBudgetManager()" class="btn-secondary" style="margin-left: 0.5rem;">‚ùå Cancel</button>
            </div>
        </div>

        <!-- Add New Expense Form -->
        <div class="form-section">
            <h2 class="form-title">‚ûï Add New Expense</h2>
            <div class="form-grid">
                <input type="text" id="newCategory" placeholder="Category (e.g., üè† House Rent)" class="form-input">
                <input type="text" id="newDescription" placeholder="Description" class="form-input">
                <input type="number" id="newAmount" placeholder="Amount (‚Çπ)" class="form-input">
                <button onclick="addExpense()" class="btn-primary">Add Expense</button>
            </div>
        </div>

        <!-- Expenses List -->
        <div class="expenses-section">
            <div class="expenses-header">
                <h2 class="expenses-title">üìã Monthly Expenses</h2>
            </div>
            <div class="table-container">
                <table class="expenses-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesList">
                        <!-- Expenses will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export/Import Options -->
        <div class="export-grid">
            <button onclick="exportData()" class="btn-secondary btn-green">üì§ Export Data</button>
            <label class="btn-secondary btn-orange">
                üì• Import Data
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData()">
            </label>
        </div>
    </div>

    <script>
        // Default expenses data
        const defaultExpenses = [
            // Fixed Monthly Expenses
            { category: "üè† House Rent", description: "Fixed rent for the flat", amount: 16500 },
            { category: "üõ†Ô∏è Maintenance Charges", description: "Apartment association maintenance", amount: 1500 },
            { category: "üí° Electricity Bill", description: "Varies by usage; assume moderate (AC, fridge, fans)", amount: 1750 },
            { category: "üíß Water + Sewage", description: "Sometimes included in maintenance, or charged separately", amount: 300 },
            { category: "üì± Mobile + Internet", description: "1‚Äì2 mobiles + broadband plan", amount: 1000 },
            { category: "üçö Groceries", description: "Monthly groceries, milk, veggies, etc.", amount: 9000 },
            { category: "üßº Household Items", description: "Soaps, detergents, cleaning supplies", amount: 750 },
            { category: "üöº Baby Needs", description: "Diapers, wipes, baby food, formula (if used), medicine", amount: 2000 },
            { category: "üßí Riyan Therapy & Fees", description: "Speech therapy or developmental activities", amount: 7500 },
            { category: "üöå Local Transport", description: "Auto, bike petrol, Ola/Uber (for therapy visits or errands)", amount: 1500 },
            { category: "üè• Healthcare (Basic)", description: "Pediatrician visits, common meds, checkups", amount: 750 },
            { category: "üçΩÔ∏è Gas Cylinder", description: "Cooking gas refill (1 every 40‚Äì50 days)", amount: 1000 },
            // Optional But Common Extras
            { category: "üéì Child Education", description: "Playschool or preschool fees (if applicable)", amount: 2750 },
            { category: "üßò Self-Care/Medical", description: "Supplements, therapy sessions for yourself, etc.", amount: 750 },
            { category: "üõçÔ∏è Clothing & Footwear", description: "Regular clothing for growing kids/family", amount: 750 },
            { category: "üéâ Subscriptions", description: "OTT (YouTube Premium, Hotstar, etc)", amount: 200 }
        ];

        let expenses = [];
        let budgets = {};
        let originalOrder = [];
        let currentSort = 'none';

        // Define all functions first to avoid reference errors
        function showBudgetManager() {
            const manager = document.getElementById('budgetManager');
            const inputsContainer = document.getElementById('budgetInputs');
            
            // Get unique categories
            const categories = [...new Set(expenses.map(expense => expense.category))];
            
            inputsContainer.innerHTML = '';
            
            categories.forEach(category => {
                const currentBudget = budgets[category] || 0;
                const safeCategoryId = category.replace(/[^a-zA-Z0-9]/g, '');
                const inputDiv = document.createElement('div');
                inputDiv.className = 'budget-input-grid';
                inputDiv.innerHTML = `
                    <label>${category}</label>
                    <input type="number" id="budget-${safeCategoryId}" value="${currentBudget}" placeholder="‚Çπ Budget limit" class="form-input">
                    <button onclick="setBudget('${category.replace(/'/g, "\\\'")}')" class="btn-small btn-blue">Set</button>
                `;
                inputsContainer.appendChild(inputDiv);
            });
            
            manager.style.display = 'block';
        }
        
        function hideBudgetManager() {
            document.getElementById('budgetManager').style.display = 'none';
        }
        
        function setBudget(category) {
            const input = document.getElementById(`budget-${category.replace(/[^a-zA-Z0-9]/g, '')}`);
            const amount = parseFloat(input.value);
            
            if (amount >= 0) {
                budgets[category] = amount;
                localStorage.setItem('categoryBudgets', JSON.stringify(budgets));
                updateBudgetOverview();
                checkBudgetAlerts();
            }
        }

        function saveBudgets() {
            localStorage.setItem('categoryBudgets', JSON.stringify(budgets));
            hideBudgetManager();
            updateBudgetOverview();
            checkBudgetAlerts();
            document.getElementById('dataStatus').textContent = 'Budgets Saved ‚úì';
            setTimeout(() => {
                document.getElementById('dataStatus').textContent = 'Saved Locally';
            }, 2000);
        }

        function resetBudgets() {
            if (confirm('Are you sure you want to reset all budgets?')) {
                budgets = {};
                localStorage.removeItem('categoryBudgets');
                updateBudgetOverview();
            }
        }

        function sortExpenses() {
            const sortValue = document.getElementById('sortSelect').value;
            currentSort = sortValue;
            
            if (sortValue === 'none') {
                expenses = [...originalOrder];
            } else if (sortValue === 'amount-high') {
                expenses.sort((a, b) => b.amount - a.amount);
            } else if (sortValue === 'amount-low') {
                expenses.sort((a, b) => a.amount - b.amount);
            }
            
            renderExpenses();
        }

        function updateBudgetOverview() {
            const budgetList = document.getElementById('budgetList');
            
            // Get spending by category
            const categorySpending = {};
            expenses.forEach(expense => {
                if (categorySpending[expense.category]) {
                    categorySpending[expense.category] += expense.amount;
                } else {
                    categorySpending[expense.category] = expense.amount;
                }
            });
            
            budgetList.innerHTML = '';
            
            // Show budgets for categories that have spending or set budgets
            const allCategories = new Set([...Object.keys(categorySpending), ...Object.keys(budgets)]);
            
            allCategories.forEach(category => {
                const spent = categorySpending[category] || 0;
                const budget = budgets[category] || 0;
                
                if (budget > 0) {
                    const percentage = Math.min((spent / budget) * 100, 100);
                    const remaining = Math.max(budget - spent, 0);
                    
                    let statusClass = 'safe';
                    let statusText = `‚Çπ${remaining.toLocaleString()} remaining`;
                    
                    if (percentage >= 100) {
                        statusClass = 'danger';
                        statusText = `Over budget by ‚Çπ${(spent - budget).toLocaleString()}`;
                    } else if (percentage >= 80) {
                        statusClass = 'warning';
                        statusText = `‚Çπ${remaining.toLocaleString()} remaining`;
                    }
                    
                    const budgetItem = document.createElement('div');
                    budgetItem.className = 'budget-item';
                    budgetItem.innerHTML = `
                        <div class="budget-header">
                            <span class="budget-category">${category}</span>
                            <span class="budget-amounts">‚Çπ${spent.toLocaleString()} / ‚Çπ${budget.toLocaleString()}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${statusClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="budget-status ${statusClass}">${statusText}</div>
                    `;
                    budgetList.appendChild(budgetItem);
                }
            });
            
            if (budgetList.children.length === 0) {
                budgetList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No budgets set. Click "Manage Budgets" to add category limits.</p>';
            }
        }

        function checkBudgetAlerts() {
            // Get spending by category
            const categorySpending = {};
            expenses.forEach(expense => {
                if (categorySpending[expense.category]) {
                    categorySpending[expense.category] += expense.amount;
                } else {
                    categorySpending[expense.category] = expense.amount;
                }
            });
            
            // Check for alerts
            Object.keys(budgets).forEach(category => {
                const spent = categorySpending[category] || 0;
                const budget = budgets[category];
                if (budget > 0) {
                    const percentage = (spent / budget) * 100;
                    
                    if (percentage >= 100) {
                        showAlert('danger', 'Budget Exceeded!', `${category}: ‚Çπ${(spent - budget).toLocaleString()} over budget`);
                    } else if (percentage >= 80) {
                        showAlert('warning', 'Budget Warning!', `${category}: ${(100 - percentage).toFixed(0)}% budget remaining`);
                    }
                }
            });
        }

        function showAlert(type, title, message) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert-popup');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert-popup ${type}`;
            alert.innerHTML = `
                <div class="alert-title">${title}</div>
                <div class="alert-message">${message}</div>
            `;
            
            document.body.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadBudgets();
            renderExpenses();
            updateSummary();
            updateBudgetOverview();
        });

        function loadData() {
            const saved = localStorage.getItem('monthlyExpenses');
            if (saved) {
                expenses = JSON.parse(saved);
                originalOrder = [...expenses];
                document.getElementById('dataStatus').textContent = 'Loaded from Storage';
            } else {
                expenses = [...defaultExpenses];
                originalOrder = [...expenses];
                saveData();
                document.getElementById('dataStatus').textContent = 'Default Data Loaded';
            }
        }

        function loadBudgets() {
            const saved = localStorage.getItem('categoryBudgets');
            if (saved) {
                budgets = JSON.parse(saved);
            }
        }

        function saveBudgets() {
            localStorage.setItem('categoryBudgets', JSON.stringify(budgets));
            hideBudgetManager();
            updateBudgetOverview();
            checkBudgetAlerts();
            document.getElementById('dataStatus').textContent = 'Budgets Saved ‚úì';
            setTimeout(() => {
                document.getElementById('dataStatus').textContent = 'Saved Locally';
            }, 2000);
        }

        function saveData() {
            localStorage.setItem('monthlyExpenses', JSON.stringify(expenses));
            document.getElementById('dataStatus').textContent = 'Saved Locally ‚úì';
            setTimeout(() => {
                document.getElementById('dataStatus').textContent = 'Saved Locally';
            }, 2000);
        }

        function addExpense() {
            const category = document.getElementById('newCategory').value.trim();
            const description = document.getElementById('newDescription').value.trim();
            const amount = parseFloat(document.getElementById('newAmount').value);

            if (!category || !description || !amount || amount <= 0) {
                alert('Please fill all fields with valid data');
                return;
            }

            expenses.push({ category, description, amount });
            originalOrder = [...expenses];
            
            // Reset sort to default when adding new expense
            document.getElementById('sortSelect').value = 'none';
            currentSort = 'none';
            
            saveData();
            renderExpenses();
            updateSummary();
            updateBudgetOverview();
            checkBudgetAlerts();

            // Clear form
            document.getElementById('newCategory').value = '';
            document.getElementById('newDescription').value = '';
            document.getElementById('newAmount').value = '';
        }

        function deleteExpense(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses.splice(index, 1);
                originalOrder = [...expenses];
                saveData();
                renderExpenses();
                updateSummary();
                updateBudgetOverview();
            }
        }

        function editExpense(index) {
            const expense = expenses[index];
            const newCategory = prompt('Edit Category:', expense.category);
            const newDescription = prompt('Edit Description:', expense.description);
            const newAmount = prompt('Edit Amount:', expense.amount);

            if (newCategory !== null && newDescription !== null && newAmount !== null) {
                const amount = parseFloat(newAmount);
                if (amount > 0) {
                    expenses[index] = {
                        category: newCategory.trim(),
                        description: newDescription.trim(),
                        amount: amount
                    };
                    originalOrder = [...expenses];
                    saveData();
                    renderExpenses();
                    updateSummary();
                    updateBudgetOverview();
                }
            }
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesList');
            tbody.innerHTML = '';

            expenses.forEach((expense, index) => {
                const row = document.createElement('tr');
                row.className = 'expense-row';
                row.draggable = true;
                row.dataset.index = index;
                
                row.innerHTML = `
                    <td><span class="drag-handle">‚ãÆ‚ãÆ</span></td>
                    <td><strong>${expense.category}</strong></td>
                    <td>${expense.description}</td>
                    <td class="amount-text">‚Çπ${expense.amount.toLocaleString()}</td>
                    <td>
                        <button onclick="editExpense(${index})" class="action-btn">‚úèÔ∏è Edit</button>
                        <button onclick="deleteExpense(${index})" class="action-btn delete">üóëÔ∏è Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to all rows after they're created
            addDragListeners();
        }
        
        function addDragListeners() {
            const rows = document.querySelectorAll('.expense-row');
            rows.forEach(row => {
                row.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });
                
                row.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    return false;
                });
                
                row.addEventListener('dragenter', function(e) {
                    if (this !== draggedElement) {
                        this.classList.add('drag-over');
                    }
                });
                
                row.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });
                
                row.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }

                    if (draggedElement !== this) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(this.dataset.index);
                        
                        // Reorder the expenses array
                        const draggedExpense = expenses[draggedIndex];
                        expenses.splice(draggedIndex, 1);
                        expenses.splice(targetIndex, 0, draggedExpense);
                        
                        // Save and re-render
                        originalOrder = [...expenses];
                        saveData();
                        renderExpenses();
                        updateSummary();
                        updateBudgetOverview();
                    }

                    this.classList.remove('drag-over');
                    return false;
                });
                
                row.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    
                    // Clean up all drag-over classes
                    const allRows = document.querySelectorAll('.expense-row');
                    allRows.forEach(row => {
                        row.classList.remove('drag-over');
                    });
                    
                    draggedElement = null;
                });
            });
        }

        function updateSummary() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalBudget').textContent = `‚Çπ${total.toLocaleString()}`;
            document.getElementById('totalItems').textContent = expenses.length;
        }

        function exportData() {
            const dataStr = JSON.stringify(expenses, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'monthly_expenses.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        expenses = imported;
                        saveData();
                        renderExpenses();
                        updateSummary();
                        alert('Data imported successfully!');
                    } else {
                        alert('Invalid file format');
                    }
                } catch (error) {
                    alert('Error reading file');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
